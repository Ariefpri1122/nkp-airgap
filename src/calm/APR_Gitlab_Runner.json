{"status":{},"spec":{"name":"APR_Gitlab_Runner","description":"","resources":{"service_definition_list":[{"name":"Gitllab_Runner","description":"","variable_list":[],"action_list":[{"type":"system","name":"action_create","description":"System action for creating an application","runbook":{"name":"20b67605_runbook","description":"","task_definition_list":[{"type":"DAG","name":"7bd45187_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Permissive","kind":"app_task"},"to_task_reference":{"name":"Disable Module","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Disable Module","kind":"app_task"},"to_task_reference":{"name":"Install Tool","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Install Tool","kind":"app_task"},"to_task_reference":{"name":"Install Docker","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Install Docker","kind":"app_task"},"to_task_reference":{"name":"Generate Key","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Generate Key","kind":"app_task"},"to_task_reference":{"name":"Install kubectl","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Install kubectl","kind":"app_task"},"to_task_reference":{"name":"Install Gitlab RUnner","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"Install Gitlab RUnner","kind":"app_task"},"to_task_reference":{"name":"harbor_registry_key","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Permissive","kind":"app_task"},{"name":"Disable Module","kind":"app_task"},{"name":"Install Tool","kind":"app_task"},{"name":"Install Docker","kind":"app_task"},{"name":"Generate Key","kind":"app_task"},{"name":"Install kubectl","kind":"app_task"},{"name":"Install Gitlab RUnner","kind":"app_task"},{"name":"harbor_registry_key","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Permissive","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nCONFIG_FILE=\"\/etc\/selinux\/config\"\n\n# Check if file exists\nif [ ! -f \"$CONFIG_FILE\" ]; then\n    echo \"SELinux config file not found: $CONFIG_FILE\"\n    exit 1\nfi\n\n# Use sed to update the SELINUX line\nsed -i 's\/^SELINUX=.*\/SELINUX=permissive\/' \"$CONFIG_FILE\"\n\n# Show result\ngrep \"^SELINUX=\" \"$CONFIG_FILE\"\n","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Disable Module","description":"","attrs":{"type":"","script":"sudo ethtool --offload ens3 rx-gro-hw off","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Install Tool","description":"","attrs":{"type":"","script":"sudo yum install -y curl wget tar zip tmux git ","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Install Docker","description":"","attrs":{"type":"","script":"sudo dnf config-manager --add-repo https:\/\/download.docker.com\/linux\/rhel\/docker-ce.repo && \\\nsudo dnf -y install docker-ce docker-ce-cli containerd.io && \\\nsudo systemctl --now enable docker && \\\nsudo usermod -aG docker nutanix","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Generate Key","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\nEMAIL=\"arief.pribadi@nutanix.com\"\nKEY_PATH=\"$HOME\/.ssh\/id_ed25519\"\n\n# Generate SSH key without passphrase\nssh-keygen -t ed25519 -C \"$EMAIL\" -f \"$KEY_PATH\" -N \"\" <<< y >\/dev\/null 2>&1\n\n# Start SSH agent if not already started\neval \"$(ssh-agent -s)\" >\/dev\/null\n\n# Add private key to SSH agent\nssh-add \"$KEY_PATH\"\n","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Install kubectl","description":"","attrs":{"type":"","script":"# install kubectl\nsudo curl -Lo \/usr\/local\/bin\/kubectl https:\/\/storage.googleapis.com\/kubernetes-release\/release\/$(curl -s https:\/\/storage.googleapis.com\/kubernetes-release\/release\/stable.txt)\/bin\/linux\/amd64\/kubectl && \\\nsudo chmod +x \/usr\/local\/bin\/kubectl && \\\nkubectl version --client\n\n# install helm\nsudo curl https:\/\/raw.githubusercontent.com\/helm\/helm\/main\/scripts\/get-helm-3 | bash && \\\nhelm version","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Install Gitlab RUnner","description":"","attrs":{"type":"","script":"curl -L \"https:\/\/packages.gitlab.com\/install\/repositories\/runner\/gitlab-runner\/script.rpm.sh\" | sudo bash\n\nsudo dnf install gitlab-runner -y\n\nexport RUNNER_TOKEN=@@{runner_token}@@\nsudo gitlab-runner register \\\n  --non-interactive \\\n  --url http:\/\/gitlab.@@{domain_name}@@ \\\n  --registration-token $RUNNER_TOKEN \\\n  --executor shell \\\n  --description vm-runner \\\n  --tag-list vm-runner","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"harbor_registry_key","description":"","attrs":{"type":"","script":"sudo mkdir -p \/etc\/docker\/certs.d\/@@{harbor_ip_address}@@:5000\nsudo wget @@{registry_ca}@@\nsudo cp ca.crt \/etc\/docker\/certs.d\/@@{harbor_ip_address}@@:5000\/ca.crt\nsudo systemctl restart docker\n\nsudo usermod -aG docker gitlab-runner\nsudo systemctl restart gitlab-runner","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"7bd45187_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_delete","description":"System action for deleting an application. Deletes created VMs as well","runbook":{"name":"c0cfb329_runbook","description":"","task_definition_list":[{"type":"DAG","name":"054f4f4f_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"054f4f4f_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_start","description":"System action for starting an application","runbook":{"name":"81cc8aed_runbook","description":"","task_definition_list":[{"type":"DAG","name":"9bb5fbd7_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"9bb5fbd7_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_stop","description":"System action for stopping an application","runbook":{"name":"035ce9cc_runbook","description":"","task_definition_list":[{"type":"DAG","name":"e1930c0c_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"e1930c0c_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_restart","description":"System action for restarting an application","runbook":{"name":"82c1d23c_runbook","description":"","task_definition_list":[{"type":"DAG","name":"ade81992_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Gitllab_Runner","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"ade81992_dag","kind":"app_task"},"variable_list":[]},"critical":false}],"depends_on_list":[],"port_list":[],"singleton":false,"tier":""}],"published_service_definition_list":[],"substrate_definition_list":[{"type":"AHV_VM","name":"VM_GitlabRunner","description":"","variable_list":[],"action_list":[],"create_spec":{"type":"","name":"apr-Gitlab_Runner-@@{calm_array_index}@@-@@{calm_time}@@","availability_zone_reference":null,"backup_policy":null,"cluster_reference":{"type":"","kind":"cluster","name":"PHX-SPOC013-3","uuid":"00063ab6-7b37-e63a-1f92-ac1f6b6d250f"},"resources":{"type":"","nic_list":[{"type":"","nic_type":"NORMAL_NIC","subnet_reference":{"type":"","kind":"subnet","name":"","uuid":"3080a658-73e7-4ef4-8895-70c2528b5461"},"network_function_nic_type":"INGRESS","mac_address":"","ip_endpoint_list":[],"network_function_chain_reference":null,"vpc_reference":null}],"power_state":"ON","guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"memory_size_mib":8192,"gpu_list":[],"parent_reference":null,"hardware_clock_timezone":"","account_uuid":"b0f45255-9274-4a95-81cb-484426fbbda1","guest_customization":{"type":"","cloud_init":{"type":"","meta_data":"","user_data":"#cloud-config\nusers:\n  - name: nutanix\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd:\n  list: |\n    nutanix:@@{nutanix.secret}@@\n  expire: False\nssh_pwauth:   true"},"sysprep":null},"boot_config":{"type":"","boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"mac_address":"","boot_type":"LEGACY"},"vtpm_config":null,"disk_list":[{"type":"","data_source_reference":{"type":"","kind":"image","name":"Rocky-9-GenericCloud-Base.latest.x86_64.qcow2","uuid":"8c6839e4-07ef-42a8-aa19-916eb5b643f7"},"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"},"disk_size_mib":204800}],"serial_port_list":[]},"categories":{}},"os_type":"Linux","readiness_probe":{"login_credential_local_reference":{"name":"nutanix","kind":"app_credential"},"connection_type":"SSH","connection_port":22,"delay_secs":"0","retries":"5","address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","disable_readiness_probe":false,"connection_protocol":""}}],"package_definition_list":[{"type":"DEB","name":"Package1","description":"","variable_list":[],"action_list":[],"service_local_reference_list":[{"name":"Gitllab_Runner","kind":"app_service"}],"version":"","options":{"type":"","install_runbook":{"name":"4bd4c028_runbook","description":"","task_definition_list":[{"type":"DAG","name":"fbe4335e_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Package1","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"fbe4335e_dag","kind":"app_task"},"variable_list":[]},"uninstall_runbook":{"name":"66a4005e_runbook","description":"","task_definition_list":[{"type":"DAG","name":"a15df8bd_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"Package1","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"a15df8bd_dag","kind":"app_task"},"variable_list":[]},"upgrade_runbook":{}}}],"app_profile_list":[{"name":"Default","description":"","variable_list":[{"type":"LOCAL","name":"registry_ca","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":true},"value":"http:\/\/10.38.13.137\/ca.crt"},{"type":"LOCAL","name":"domain_name","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":true},"value":"arief.com"},{"type":"LOCAL","name":"runner_token","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":true},"value":""},{"type":"LOCAL","name":"harbor_ip_address","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":true},"value":""}],"action_list":[],"deployment_create_list":[{"type":"GREENFIELD","name":"deployment_b24879a5","description":"","variable_list":[],"action_list":[],"depends_on_list":[],"min_replicas":"1","max_replicas":"1","default_replicas":"1","package_local_reference_list":[{"name":"Package1","kind":"app_package"}],"substrate_local_reference":{"name":"VM_GitlabRunner","kind":"app_substrate"},"published_service_local_reference_list":[]}],"snapshot_config_list":[],"restore_config_list":[],"environment_reference_list":[],"application_url":"","patch_list":[]}],"credential_definition_list":[{"type":"PASSWORD","name":"nutanix","description":"","username":"nutanix","secret":{"attrs":{"secret_reference":{},"is_secret_modified":true},"value":"ESFizAM8MLxaIIFqt7L5ZsAI0QdGYQKw0cI7rTTn7DBp9lZY\/nzdl06G:utf-8"},"cred_class":"static"}],"default_credential_local_reference":{"name":"nutanix","kind":"app_credential"},"type":"USER","client_attrs":{"null":{"x":431,"y":315},"deployment_b24879a5":{"x":-316.25,"y":-2126.5}}}},"api_version":"3.0","product_version":"4.1.0","metadata":{"last_update_time":"1753920731719490","creation_time":"1753898982292892","spec_version":16,"name":"APR_Gitlab_Runner","kind":"blueprint"},"contains_secrets":true}
