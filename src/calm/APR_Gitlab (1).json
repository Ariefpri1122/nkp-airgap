{"status":{},"spec":{"name":"APR_Gitlab","description":"* [GitLab UI](http:\/\/@@{GitLab.address}@@)","resources":{"service_definition_list":[{"name":"GitLabService","description":"","variable_list":[],"action_list":[{"type":"system","name":"action_create","description":"System action for creating an application","runbook":{"name":"996d8a5c_runbook","description":"","task_definition_list":[{"type":"DAG","name":"f4abb190_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"f4abb190_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_delete","description":"System action for deleting an application. Deletes created VMs as well","runbook":{"name":"66840d45_runbook","description":"","task_definition_list":[{"type":"DAG","name":"8a1f4560_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"8a1f4560_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_start","description":"System action for starting an application","runbook":{"name":"c80d8ddb_runbook","description":"","task_definition_list":[{"type":"DAG","name":"9950a5bb_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"9950a5bb_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_stop","description":"System action for stopping an application","runbook":{"name":"63ef680c_runbook","description":"","task_definition_list":[{"type":"DAG","name":"1d9afbe6_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"1d9afbe6_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_restart","description":"System action for restarting an application","runbook":{"name":"057e760c_runbook","description":"","task_definition_list":[{"type":"DAG","name":"724e6dd1_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"724e6dd1_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"user","name":"CommonSetup","description":"","runbook":{"name":"b4c3d98d_runbook","description":"","task_definition_list":[{"type":"DAG","name":"1701d5d0_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"Disk Setup","kind":"app_task"},"to_task_reference":{"name":"GitLab Setup","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"Disk Setup","kind":"app_task"},{"name":"GitLab Setup","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Disk Setup","description":"","attrs":{"type":"","script":"#!\/bin\/bash\nset -ex\n\n##############################################\n# Name        : Generic_disk_setup_to_opt.sh\n# Author      : Calm Devops\n# Version     : 1.0\n# Description : Script is used to group all possible disk to single group and create one logical volume of that\n# Compatibility : Rocky 8\n##############################################\n\n\n# Update the system\nsudo yum install dnf -y\nsudo rpm --import https:\/\/www.elrepo.org\/RPM-GPG-KEY-elrepo.org\nsudo dnf install -qy https:\/\/www.elrepo.org\/elrepo-release-8.el8.elrepo.noarch.rpm\nsudo dnf -qy install epel-release\nsudo dnf update -qy\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/sysconfig\/selinux\nsudo sed -i 's\/^SELINUX=.*\/SELINUX=disabled\/' \/etc\/selinux\/config\nsudo systemctl stop firewalld || :\nsudo systemctl disable firewalld || :\nsudo setenforce 0\nsudo dnf install chrony\nsudo systemctl start chronyd\nsudo systemctl enable chronyd\nsudo yum install -y lvm2 --quiet \nsudo dnf update -y --quiet\n\n# Install required packages\nsudo dnf install -y --quiet lvm2 libudev-devel\n\n# Initialize an empty list to store unused\/unclaimed disks\npv_list=\"\"\n\n# Iterate through drive letters from 'a' to 'z'\nfor x in {a..z}; do\n    if [ -e \/dev\/sd$x ]; then\n        # For non-AWS providers\n        data_flag=$(sudo file -sL \/dev\/sd$x | cut -d ':' -f2 | tr -d ' ')\n        if [ \"$data_flag\" == \"data\" ]; then\n            sudo pvcreate \/dev\/sd$x\n            pv_list+=\"\/dev\/sd$x \"\n        fi\n    elif [ -e \/dev\/xvd$x ]; then\n        # For AWS disks\n        data_flag=$(sudo file -sL \/dev\/xvd$x | cut -d ':' -f2 | tr -d ' ')\n        if [ \"$data_flag\" == \"data\" ]; then\n            sudo pvcreate \/dev\/xvd$x\n            pv_list+=\"\/dev\/xvd$x \"\n        fi\n    fi\ndone\n\n# If there are unclaimed disks, create a volume group (vg01)\nif [[ ! -z $pv_list ]]; then\n    eval sudo vgcreate vg01 $pv_list                   # vg01 is created with all unclaimed \/ unused disks\n    sudo lvcreate -l 100%VG -n lv01 vg01               # lv01 is created from vg01 \n    sudo mkfs.xfs \/dev\/vg01\/lv01\n    echo -e \"\/dev\/vg01\/lv01 \\t \/opt \\t xfs \\t defaults \\t 0 0\" | sudo tee -a \/etc\/fstab\n    sudo mount -a\nfi\n","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"rocky","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"GitLab Setup","description":"","attrs":{"type":"","script":"#!\/bin\/bash\nset -ex\n\n##############################################\n# Name        : Gitlab_setup.sh\n# Author      : Calm Devops\n# Version     : 1.0\n# Description : Script to set up GitLab \n# Compatibility : Rocky 8\n##############################################\n\nGITLAB_DNS_NAME=\"@@{GITLAB_DNS_NAME}@@\"\n\nsudo dnf install -y curl openssh-server policycoreutils perl postfix \n\nsudo systemctl start postfix\nsudo systemctl enable postfix\n\ncurl https:\/\/packages.gitlab.com\/install\/repositories\/gitlab\/gitlab-ce\/script.rpm.sh | sudo bash\n\nsudo dnf install -y gitlab-ce\nif [[ \"${GITLAB_DNS_NAME}x\" != \"x\" ]]; then\n  sudo sed -i \"s#external_url 'http:\/\/gitlab.example.com'#external_url 'http:\/\/${GITLAB_DNS_NAME}'#\" \/etc\/gitlab\/gitlab.rb\nfi\nsudo gitlab-ctl reconfigure\n","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"rocky","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"1701d5d0_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"user","name":"CommonUninstall","description":"","runbook":{"name":"1e125f07_runbook","description":"","task_definition_list":[{"type":"DAG","name":"06aa513a_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"Gitlab Uninstall","kind":"app_task"}],"variable_list":[],"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"Gitlab Uninstall","description":"","attrs":{"type":"","script":"#!\/bin\/bash\nset -ex\n\n##############################################\n# Name        : Gitlab_uninstallation.sh\n# Author      : Calm Devops\n# Version     : 1.0\n# Description : Script to remove gitlab \n# Compatibility : Rocky 8\n##############################################\n\nsudo dnf remove -y gitlab*","script_type":"sh","command_line_args":"","exit_status":[],"login_credential_local_reference":{"name":"rocky","kind":"app_credential"}},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"06aa513a_dag","kind":"app_task"},"variable_list":[]},"critical":false}],"depends_on_list":[],"port_list":[],"singleton":false,"tier":""}],"published_service_definition_list":[],"substrate_definition_list":[{"type":"AHV_VM","name":"AHV_ GitLab","description":"","variable_list":[],"action_list":[],"editables":{"readiness_probe":{"retries":true,"delay_secs":true,"timeout_secs":null},"create_spec":{"resources":{"disk_list":{"0":{"device_properties":{"disk_address":{}}},"1":{"device_properties":{"device_type":true,"disk_address":{"device_index":true,"adapter_type":true}},"disk_size_mib":true},"2":{"device_properties":{"device_type":true,"disk_address":{"device_index":true,"adapter_type":true}},"disk_size_mib":true},"3":{"device_properties":{"device_type":true,"disk_address":{"device_index":true,"adapter_type":true}},"disk_size_mib":true}},"memory_size_mib":true,"num_sockets":true,"guest_customization":true,"num_vcpus_per_socket":true,"boot_config":{"boot_device":true},"gpu_list":true,"serial_port_list":{},"nic_list":{"0":{"ip_endpoint_list":true,"subnet_reference":true,"vpc_reference":true}}},"name":true,"categories":true,"cluster_reference":true}},"create_spec":{"type":"","name":"gitlab-@@{calm_time}@@","availability_zone_reference":null,"backup_policy":null,"cluster_reference":{"type":"","kind":"cluster","name":"PHX-SPOC013-3","uuid":"00063ab6-7b37-e63a-1f92-ac1f6b6d250f"},"resources":{"type":"","nic_list":[{"type":"","nic_type":"NORMAL_NIC","subnet_reference":{"type":"","kind":"subnet","name":"","uuid":"3080a658-73e7-4ef4-8895-70c2528b5461"},"network_function_nic_type":"INGRESS","mac_address":"","ip_endpoint_list":[],"network_function_chain_reference":null,"vpc_reference":null}],"power_state":"ON","guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"memory_size_mib":24576,"gpu_list":[],"parent_reference":null,"hardware_clock_timezone":"","account_uuid":"b0f45255-9274-4a95-81cb-484426fbbda1","guest_customization":{"type":"","cloud_init":{"type":"","meta_data":"","user_data":"#cloud-config\nusers:\n  - name: rocky\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd:\n  list: |\n    rocky:@@{rocky.secret}@@\n  expire: False\nssh_pwauth: true"},"sysprep":null},"boot_config":{"type":"","boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"mac_address":"","boot_type":""},"vtpm_config":null,"disk_list":[{"type":"","data_source_reference":{"type":"","kind":"app_package","name":"AHV_ROCKY_89","uuid":"157674f2-5536-4c1c-b840-0ce82dae273e"},"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"},"disk_size_mib":51200},{"type":"","data_source_reference":null,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"},"disk_size_mib":10240},{"type":"","data_source_reference":null,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":2,"adapter_type":"SCSI"},"device_type":"DISK"},"disk_size_mib":10240},{"type":"","data_source_reference":null,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":3,"adapter_type":"SCSI"},"device_type":"DISK"},"disk_size_mib":10240}],"serial_port_list":[]},"categories":{}},"os_type":"Linux","readiness_probe":{"login_credential_local_reference":{"name":"rocky","kind":"app_credential"},"connection_type":"SSH","connection_port":22,"delay_secs":"30","retries":"5","address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","disable_readiness_probe":false,"connection_protocol":""}}],"package_definition_list":[{"type":"DEB","name":"AHV_ GitLab_Package","description":"","variable_list":[],"action_list":[],"service_local_reference_list":[{"name":"GitLabService","kind":"app_service"}],"version":"","options":{"type":"","install_runbook":{"name":"9b8ae323_runbook","description":"","task_definition_list":[{"type":"DAG","name":"cf645cf4_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"Common Setup","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"AHV_ GitLab_Package","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"CALL_RUNBOOK","name":"Common Setup","description":"","attrs":{"type":"CALL_RUNBOOK","runbook_reference":{"name":"b4c3d98d_runbook","kind":"app_runbook"},"inarg_list":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"cf645cf4_dag","kind":"app_task"},"variable_list":[]},"uninstall_runbook":{"name":"53425ff7_runbook","description":"","task_definition_list":[{"type":"DAG","name":"cd4fcf4f_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[{"name":"Common Uninstall","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"AHV_ GitLab_Package","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"CALL_RUNBOOK","name":"Common Uninstall","description":"","attrs":{"type":"CALL_RUNBOOK","runbook_reference":{"name":"1e125f07_runbook","kind":"app_runbook"},"inarg_list":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"GitLabService","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"cd4fcf4f_dag","kind":"app_task"},"variable_list":[]},"upgrade_runbook":{}}},{"type":"SUBSTRATE_IMAGE","name":"AHV_ROCKY_89","description":"AHV_ROCKY_89.qcow2","variable_list":[],"action_list":[],"service_local_reference_list":[],"version":"","options":{"type":"","name":"AHV_ROCKY_89","resources":{"type":"","image_type":"DISK_IMAGE","checksum":{"type":"","checksum_algorithm":"","checksum_value":""},"source_uri":"https:\/\/download.nutanix.com\/Calm\/AHV_ROCKY_89.qcow2","version":{"type":"","product_version":"8.9","product_name":"Rocky 8"},"architecture":"X86_64"},"description":""}}],"app_profile_list":[{"name":"Nutanix","description":"","variable_list":[{"type":"LOCAL","name":"GITLAB_DNS_NAME","description":"","is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":true},"value":"gitlab.arief.com"}],"action_list":[],"deployment_create_list":[{"type":"GREENFIELD","name":"6a931e0b_deployment","description":"","variable_list":[],"action_list":[],"depends_on_list":[],"min_replicas":"1","max_replicas":"1","default_replicas":"1","package_local_reference_list":[{"name":"AHV_ GitLab_Package","kind":"app_package"}],"substrate_local_reference":{"name":"AHV_ GitLab","kind":"app_substrate"},"published_service_local_reference_list":[]}],"snapshot_config_list":[],"restore_config_list":[],"environment_reference_list":[],"application_url":"","patch_list":[]}],"credential_definition_list":[{"type":"PASSWORD","name":"rocky","description":"","editables":{"username":true,"secret":true},"username":"rocky","secret":{"attrs":{"secret_reference":{},"is_secret_modified":true},"value":"6NEsAmcnSJg4emUUGRK3EC+zLh3iNFPW26d7v62S6ZeRwA0YiAQdZqbU:utf-8"},"cred_class":"static"}],"default_credential_local_reference":{"name":"rocky","kind":"app_credential"},"type":"USER","client_attrs":{"null":{"y":139.5,"x":440},"9e52fb5e-f07d-4f11-a228-6c07d6a52f26":{"y":2.0260965002922724,"x":-244.18654735921535},"2660af3f-d277-411d-8cf2-fba12cbff8ce":{"y":2.0260965002922724,"x":-244.18654735921535},"4e591ca8-c42e-4302-91de-aa040e583125":{"y":2.0260965002922724,"x":-244.18654735921535},"1618e7fb-03c0-4238-8b0a-027f5c675651":{"y":2.0260965002922724,"x":-244.18654735921535},"6a931e0b_deployment":{"y":2.0260965002922724,"x":-244.18654735921535}}}},"api_version":"3.0","product_version":"4.1.0","metadata":{"last_update_time":"1753895843382537","creation_time":"1753895416922288","spec_version":7,"name":"APR_Gitlab","kind":"blueprint","categories":{"AppFamily":"DevOps"}},"contains_secrets":true}