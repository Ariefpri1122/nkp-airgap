Lab 03: Deploy & Configure Harbor
---------------------------------

Harbor Installation
	1.	From NKP Dashboard - Management Cluster Workspace - Applications
	2.	In Application - change all categories to general
		-	Enable CloudNativePG
			* Using k8s dashboard All Namespace --> see the deployment finished and success
			* Confirmed in Management Cluster - Applications - CloudNativePG is “Deployed” —> not “Enabled”
		-	Enable Harbor - Choose “Rook Chef” as S3 Object Store
			* Using k8s dashboard see the deployment finished and success --> if no harbor deployment shown in k8s dashboard in 5 minutes, try to disable and enable again harbor application from NKP Dashboard
			* Confirmed in Management Cluster - Applications -  Harbor is “Deployed” —> not “Enabled”
		- Open your kubernetes dashboard - open namespace "ncr-system"
			* click the Workloads icon (Top left under kubertenes logo)
			* you will see harbor jobs (creating database cluster), pods and other resources start running
			* wait until deployment resources created and finished

	3.	From code-server (Bastion) —> kubectl get secrets -n ncr-system harbor-admin-password -o jsonpath='{.data.HARBOR_ADMIN_PASSWORD}' | base64 -d
		-	TlooTlYb6i=gKBYF20Np

	4.	From Management Cluster - Application Dashboard - Harbor —> Click Dashboard
		-	Login to harbor —> username: admin & password: (as mentioned above)
		-	Select Administration - Users —> Click New User
		-	Enter information:
			* username	: nutanix
			* email		: nutanix@nutanix.com
			* Firstname	: nutanix
			* password	: [your nutanix cluster password]
			* confirm	: [your nutanix cluster password]
			* Save

	5. Click your new username and mark it as ADMIN
	6. Logout  and login again as new user 
	
	7. Configure and Create Docker Proxy Cache Registry 
		- From Harbor Dashboard - Administration - Registries - New Endpoint
			* Provider		: Docker Hub
			* Name			: Docker Hub
			* Access ID		: [your docker username]
			* Secret		: [your docker password]
			* Verify Cert	: Checked
			* Click Test Connection —> “Connection tested sucessfully”
			* Click OK
		- From Harbor Dashboard - Project - New Project
			* Project Name	: proxy_cache
			* Access Level	: checked Public
			* Click the Proxy Cache slider and then select your registry endpoint —>  Docker Hub-https://hub.docker.com
			* Click OK

	8.	Check docker login and docker push from Code-Server (BASTION VM)
		⁃	Get harbor address (ex: 10.38.106.41:5000) :
		        * export HARBOR_ADDRESS="$(kubectl -n kommander get kommandercluster host-cluster -o jsonpath='{.status.ingress.address}')"
		        * echo $HARBOR_ADDRESS 
        ⁃	sudo mkdir /etc/docker/certs.d/$HARBOR_ADDRESS:5000
		-	kubectl get kommandercluster -n kommander host-cluster -o jsonpath='{.status.ingress.caBundle}' | base64 -d > ca.crt
		⁃	cat ca.crt
        -   sudo cp ca.crt /etc/docker/certs.d/$HARBOR_ADDRESS:5000/ca.crt
		⁃	sudo systemctl restart docker
		-	sudo cp /etc/docker/certs.d/$HARBOR_ADDRESS:5000/ca.crt /etc/pki/ca-trust/source/anchors/
		-	sudo update-ca-trust

		Test Login to Harbor:
        -   Please be aware to change the password with your cluster password !!!
		⁃	docker login -u nutanix -p nx2Tech974! https://$HARBOR_ADDRESS:5000/ —> must be “Login Succeeded”
		⁃	docker pull $HARBOR_ADDRESS:5000/proxy_cache/goharbor/harbor-core:dev
		⁃	docker pull $HARBOR_ADDRESS:5000/proxy_cache/hello-world:latest
		⁃	docker tag $HARBOR_ADDRESS:5000/proxy_cache/hello-world $HARBOR_ADDRESS:5000/library/hello-world
		⁃	docker image ls
		⁃	docker push $HARBOR_ADDRESS:5000/library/hello-world
        ⁃	from harbor dashboard examine:
            * Projects - proxy_cache - repositories
            * Projects - library - repositories
