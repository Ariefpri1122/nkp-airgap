Workshop NKP Builder

1. Reserved HPOC
    1. PC = pc.2024.3.1.4
    2. AOS = 6.10
    3. NKP = 2.13.2
2. increase and update autoad VM memory to 16GB (VM must be shutdown to change and power on after)
3. Configure windows IIS with folder browsing allowed
4. Note on these HPOC File Shares:
    * PHX: http://phx-dfs01 or http://10.42.194.11
    * DM3: http://rtp-dfs01 or http://10.55.251.38
    * BLR: http://blr-dfs01 or http://10.136.239.13
5. Install Chrome and make it default —> http://10.42.194.11/misc/Google/Chrome/ChromeSetup.exe
6. Download all necessary files and put all in c:\inetpub\wwwroot and delete iis.* file on autoad VM
    1. Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 —> https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
    2. nexus-3.82.0-08-linux-x86_64.tar.gz —> https://download.sonatype.com/nexus/3/nexus-3.82.0-08-linux-x86_64.tar.gz
    3. nkp-rocky-9.5-release-1.30.5-20250609192903.qcow2
    4. nkp-air-gapped-bundle_v2.13.2_linux_amd64.tar.gz —> https://download.nutanix.com/downloads/nkp/v2.15.0/nkp-air-gapped-bundle_v2.15.0_linux_amd64.tar.gz?Expires=1753377219&Key-Pair-Id=APKAJTTNCWPEI42QKMSA&Signature=dyWoz7W-oM8amzasPkYXlePLRIip81SR8Hqf03KTvmjQmyXNtS3YgNAY0GIuMlhP7D6UaiLjQE9DwSdnIu2JmStq3EW9xtsJ~a1LtLBG8k07qmQDHGcD75E2CaVhf-oE7gy4mv0X-P6vottvNN5RzxQDXjr9POO7xOddQhqLLyCRiXP9nUs5lFcHLeRbhWu05-VnlSm-k~InY76W8-hgVBK5OvsdBap2n0NaUCMxdgdwfpmKx5SMNKnmGXNai~N00VKOiMxv3B-do5rClwbEPN-bxEjEFOrFw~BZwcTEmY3bNPaqjV1hMMK3I1piSyKiIsjIi3ngOcocCORo7QTL3g__
7. Deploy BP Private_Mirror_VM
    1. Upload Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 to Cluster Image Service
    2. Manage project —> make sure VLAN enabled in the project
    3. Configure nexus_location variable
    4. Configure Cluster
    5. Configure Image
    6. Side Disk : 200 GB
    7. Add Nic and select vlan
    8. Check log-in upon create and every subsequent
8. Configure DNS Setting from autoad VM
    1. Create Forward Zone [yourname.com] in DNS server
    2. Add A host record airgap with its IP address (map to Mirror VM)
    3. Add A host record registry with its IP address (map to Registry VM)
    4. Check URL https://airgap.arief.com:5000/v2/_catalog 
        1. If not running check container is exist —> sudo docker ps -l
        2. If exist but not running delete the container —> sudo rm -f [container_id]
        3. Run new container —> sudo docker run -d -p 5000:5000  --restart=always --name DockerRegistry -v /mnt/registry:/var/lib/registry -v `pwd`/auth:/auth -e "REGISTRY_AUTH=htpasswd" -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd -v `pwd`/certs:/certs -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key registry:2
9. Deploy BP Bastion_VM
    1. Upload Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 to Cluster Image Service
    2. Manage project —> make sure VLAN enabled in the project
    3. Configure airgap variable
    4. Configure Cluster
    5. Configure Image
    6. Side Disk : 200 GB
    7. Add Nic and select vlan
    8. Check log-in upon create and every subsequent
    9. Add A host record in autoadVM —> bastion with its IP address (map to Bastion VM)
10. Configure OSS Nexus by accessing Registry VM IP Address:8081
    1. Create new repository -> docker (proxy)
        1. name [bebas tapi harus di isi]: docker-registry-io
        2. online: di checklist
        3. remote storage [boleh pake registry lainnya]: https://registry-1.docker.io
        4. Docker Index [pilih]: Use Docker Hub
        5. Blob store [pilih bebas]: default
    2. Create new repository -> docker (hosted)
        1. name [bebas tpi harus di isi]: docker-repository
        2. online: di checklist
        3. HTTP [di checklist dan di isi port contohnya]: 8087
        4. Allow anonnymuous docker pull [di checklist klo mau yang bisa ngepull tanpa login]: uncheked
        5. Enable Docker V1 API [docker engine version]: unchecked
        6. Deployment policy [Tergantung kebutuhan, klo saya pilih Allow redeploy supaya tanpa ganti tags]: Allow redeploy
    3. Create new repository -> docker (group)
        1. Name [bebas, tapi harus diisi]: docker-repository-public
        2. Online: checked
        3. HTTP: 8086
        4. Allow anonnymuous docker pull [di checklist klo mau yang bisa ngepull tanpa login]: uncheked
        5. Blob store: default
        6. Member repositories: pilih semua repository yang kita telah buat 
11. Check https access to https://registry.[yourname.com] (nginx reverse proxy to oss nexus port 8081)
12. Deploy BP Bastion
13. Upload nkp-rocky-9.5-release-1.30.5-20250609192903.qcow2 image to prism central images
14. From bastion VM modify the NKP configuration file and execute
    1. Note that IP Address range in HPOC Primary VLAN is —> x.x.x.1 - x.x.x.126
    2. Note that IP Address range in HPOC Secondary VLAN is —> x.x.x.190 - x.x.x.254
15. Check avail NKP Ultimate license and its expired Date
    1. https://portal.nutanix.com/page/licensing (See License with Key)
    2. search by “nkp” find NKP Ultimate license and its expiry date
    3. Note the “cluster name” —> put the same name in “export NKP_CLUSTER_NAME” below
    4. Example:
        1. nkp cluster name —> airgapped-hm-nkp-demo-2
        2. license key —> AEAAQ-AAA6Z-57CF6-C7CUH-AVRDV-TT8LD-P9ES2
16. Upload Registry /etc/docker/certs.d/airgap.arief.com\:5000/cert.crt to c:\inetpub\wwwroot in autoad vm 
    1. (use winscp to copy it from bastion VM) 

export IMAGE=nkp-rocky-9.5-release-1.32.3-20250605191120.qcow2
export NUTANIX_USER=admin
export NUTANIX_PASSWORD=nx2Tech806!
export NUTANIX_ENDPOINT=https://10.38.16.74:9440/
export CLUSTER_NAME=PHX-SPOC016-2
export STORAGE_CONTAINER=default
export SSH_PUBLIC_KEY=.ssh/id_ed25519.pub
export AIRGAP_REGISTRY_CACERT=/etc/docker/certs.d/airgap.arief.com\:5000/cert.crt
export AIRGAP_REGISTRY_URL=https://airgap.arief.com:5000
export AIRGAP_REGISTRY_USERNAME=admin
export AIRGAP_REGISTRY_PASSWORD=nutanix/4u
export NKP_CLUSTER_NAME=airgapped-hm-nkp-demo-2
export SUBNET=primary-PHX-SPOC016-2
export CONTROLPLANE_VIP=10.38.16.65
export METALLB_IP_RANGE=10.38.16.66-10.38.16.70

nkp create cluster nutanix \
    --cluster-name=${NKP_CLUSTER_NAME} \
    --control-plane-prism-element-cluster=${CLUSTER_NAME} \
    --worker-prism-element-cluster=${CLUSTER_NAME} \
    --control-plane-subnets=${SUBNET} \
    --worker-subnets=${SUBNET} \
    --control-plane-endpoint-ip=${CONTROLPLANE_VIP} \
    --csi-storage-container=${STORAGE_CONTAINER} \
    --endpoint=${NUTANIX_ENDPOINT} \
    --control-plane-vm-image=${IMAGE} \
    --worker-vm-image=${IMAGE} \
    --registry-mirror-url=${AIRGAP_REGISTRY_URL} \
    --registry-mirror-username=${AIRGAP_REGISTRY_USERNAME} \
    --registry-mirror-password=${AIRGAP_REGISTRY_PASSWORD} \
    --registry-mirror-cacert=${AIRGAP_REGISTRY_CACERT} \
    --kubernetes-service-load-balancer-ip-range=${METALLB_IP_RANGE} \
    --ssh-public-key-file=${SSH_PUBLIC_KEY} \
    --control-plane-replicas 1 \
    --control-plane-cores-per-vcpu 1 \
    --control-plane-vcpus 8 \
    --control-plane-memory 16 \
    --worker-replicas 2 \
    --worker-vcpus 8 \
    --worker-cores-per-vcpu 1 \
    --worker-memory 16 \
    --insecure \
    --self-managed

12. nkp get dashboard --kubeconfig="/home/nutanix/nkp-kommander.conf"
    1. Username: cool_carver
    2. Password: 3Hvl7iiSqD3TdyaidIJWPZBkzPji9ZDjbrrGSQZAa35uwJKcs6zY1ehCiaYw85ye
    3. URL: https://10.38.190.41/dkp/kommander/dashboard
13. Get trial license 
    1. https://portal.nutanix.com/page/licensing
    2. export KUBECONFIG=./nkp-kommander.conf 
    3. NKP Cluster Name —> kubectl get cluster -o jsonpath='{.items[0].metadata.name}'
    4. NKP Cluster UUID —> kubectl get namespace kube-system --output jsonpath={.metadata.uid}

